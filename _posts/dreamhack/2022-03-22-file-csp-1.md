---
title: "[dreamhack] file-csp-1ë²ˆ ë¬¸ì œ í’€ì´"
categories:
  - dreamhack
tags:
  - dreamhack
  - csp
toc: true
toc_sticky: true
toc_label: "file-csp-1ë²ˆ ë¬¸ì œ í’€ì´"
toc_icon: "bookmark"
author_profile: true
hidden: true
---

ğŸ’¡ dreamhack file-csp-1ë²ˆ ë¬¸ì œì— ëŒ€í•œ í’€ì´ì…ë‹ˆë‹¤.
{: .notice--warning}

# ë¬¸ì œ

![image](https://user-images.githubusercontent.com/33647663/159409028-552fd4c0-8fb2-4fbc-9250-07f3cb04d14c.png)

ë¬¸ì œì—ì„œ ìš”êµ¬í•˜ëŠ” ì¡°ê±´ì— ë§ê²Œ CSPë¥¼ ì‘ì„±í•˜ë©´ ë˜ëŠ” ë¬¸ì œì…ë‹ˆë‹¤. 
ì½”ë“œë ˆë²¨ì—ì„œ ìš”êµ¬í•˜ëŠ” ì¡°ê±´ì€ ì•„ë˜ì™€ ê°™ìŠµë‹ˆë‹¤.

```python
@APP.route('/test', methods=['GET', 'POST'])
def test_csp():
    global CSP
    if request.method == 'POST':
        csp = request.form.get('csp')
        # start bot..
        try:
            options = webdriver.ChromeOptions()
            for _ in ['headless', 'window-size=1920x1080', 'disable-gpu', 'no-sandbox', 'disable-dev-shm-usage']:
                options.add_argument(_)
            driver = webdriver.Chrome('/chromedriver', options=options)
            driver.implicitly_wait(3)
            driver.set_page_load_timeout(3)
            driver.get(f'http://localhost:8000/live?csp={quote(csp)}')
            try:
                a = driver.execute_script('return a()');
            except:
                a = 'error'
            try:
                b = driver.execute_script('return b()');
            except:
                b = 'error'
            try:
                c = driver.execute_script('return c()');
            except Exception as e:
                c = 'error'
                c = e
            try:
                d = driver.execute_script('return $(document)');
            except:
                d = 'error'

            if a == 'error' and b == 'error' and c == 'c' and d != 'error':
                return FLAG

            return f'Try again!, {a}, {b}, {c}, {d}'
        except Exception as e:
            return f'An error occured!, {e}'

    return render_template('check.html')
```

/test í˜ì´ì§€ì—ì„œ csp ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´, ë´‡ì´ ```http://localhost:8000/live?csp={quote(csp)}```ë¡œ ì ‘ê·¼í•©ë‹ˆë‹¤. ê·¸ ì´í›„ ì´ 4ê°œì˜ scriptë¥¼ ì‹¤í–‰í•˜ë©°, ê·¸ ê²°ê³¼ë¡œì¨ a,b ëŠ” ì‹¤í–‰ì´ ì•ˆë˜ê³ , c,dëŠ” ì‹¤í–‰ì´ ë˜ë„ë¡ í•˜ë©´ í”Œë˜ê·¸ë¥¼ ì¶œë ¥í•´ ì£¼ëŠ” ë¬¸ì œì…ë‹ˆë‹¤.

ê·¸ë¦¬ê³  /liveí˜ì´ì§€ëŠ” ë‹¤ìŒê³¼ ê°™ì´ êµ¬ì„±ë˜ì–´ ìˆìŠµë‹ˆë‹¤.

```python
@APP.route('/live', methods=['GET'])
def live_csp():
    csp = request.args.get('csp', '')
    resp = make_response(render_template('csp.html'))
    resp.headers.set('Content-Security-Policy', csp)
    return resp
```

íŒŒë¼ë¯¸í„°ë¡œ ì¤€ csp ì •ë³´ë¥¼ **Content-Security-Policy** ê°’ìœ¼ë¡œ ê·¸ëŒ€ë¡œ ë„£ì–´ ì¤Œìœ¼ë¡œì¨ ì‚¬ìš©ìê°€ CSP ì„¤ì •ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

ê²°ê³¼ì ìœ¼ë¡œ /testí˜ì´ì§€ì—ì„œ CSP ë¬¸ë²•ì— ë§ê²Œ CSPë¥¼ ë„˜ê²¨ì£¼ë©´, live í˜ì´ì§€ì—ì„œ í•´ë‹¹ CSP ì •ë³´ê°€ í—¤ë”ì— í¬í•¨ë˜ì–´ ë³´ì—¬ì§€ë©° ì´ë•Œ, a,b ìŠ¤í¬ë¦½íŠ¸ëŠ” ì‹¤í–‰ì´ ì•ˆë˜ê³ , c,dëŠ” ì‹¤í–‰ì´ ë˜ëŠ” CSPì—¬ì•¼ í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.

# ë¬¸ì œí’€ì´
ì´ ë¬¸ì œëŠ” ë‹¤ë¥¸ ì¡°ê±´ì´ ì—†ê¸° ë•Œë¬¸ì— í•´ì‹œ ê°’ì„ ì´ìš©í•˜ì—¬, ì£¼ì–´ì§„ í•´ì‹œ ê°’ì„ ê°€ì§„ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰ì´ ë˜ë„ë¡ í•´ì¤ë‹ˆë‹¤. 

ìš°ì„  ê°ê°ì˜ ìŠ¤í¬ë¦½íŠ¸ì˜ í•´ì‹œ ê°’ì„ ì–»ê¸° ìœ„í•´ì„œ ë‹¤ìŒê³¼ ê°™ì´ CSPë¥¼ ì„¤ì •í•´ ì¤ë‹ˆë‹¤.


```javascript
script-src 'nonce-1'
//http://host1.dreamhack.games:19954/live?csp=script-src 'nonce-1'
```

CSPë¥¼ 'nonce-1'ë¡œ ì§€ì •í•˜ë©´, í•´ë‹¹ ìŠ¤í¬ë¦½íŠ¸ì˜ 'nonce'ê°’ì„ '1'ë¡œ ì£¼ì–´ì•¼ ì‹¤í–‰ ê°€ëŠ¥í•˜ë‹¤ëŠ” ì˜ë¯¸ ì…ë‹ˆë‹¤. ì‹¤í–‰ ê²°ê³¼ëŠ” ë‹¤ìŒê³¼ ê°™ì´ 4ê°œì˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ëª¨ë‘ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.


![image](https://user-images.githubusercontent.com/33647663/159410295-d9b071a4-2680-42a0-b72d-d7b4fb11c73d.png)


ê·¸ ì´ìœ ëŠ” í˜„ì¬ ë¬¸ì œì—ì„œ csp.html íŒŒì¼ì„ ë³´ë©´ ìŠ¤í¬ë¦½íŠ¸ì˜ nonceëŠ” a,dëŠ” ì—†ê³ , b,cëŠ” "i_am_super_random"ë¡œ ì„¤ì •ë˜ì–´ ìˆê¸° ë•Œë¬¸ì— ëª¨ë“  ìŠ¤í¬ë¦½íŠ¸ê°€ ì‹¤í–‰ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```html
<head>
<!-- block me -->
<script>
	function a() { return 'a'; }
</script>
<!-- block me -->
	<script nonce="i_am_super_random">
	function b() { return 'b'; }
</script>
<!-- allow me -->
	<script nonce="i_am_super_random">
	function c() { return 'c'; }
</script>

<!-- allow me -->
<script
src="https://code.jquery.com/jquery-3.4.1.slim.min.js"
integrity="sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8="
crossorigin="anonymous"></script>
```

ì½˜ì†”ì— ì¶œë ¥ëœ ì˜¤ë¥˜ ë©”ì‹œì§€ ì¤‘ í•˜ë‚˜ë¥¼ ê°€ì ¸ì˜¤ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

```
Refused to execute inline script because it violates the following Content Security Policy directive: "script-src 'nonce-1'". 
Either the 'unsafe-inline' keyword, a hash ('sha256-P9oV1Sc7O1Di7wEu1Q0fc9Jb2+DopNb6840c7E5XuNY='), 
or a nonce ('nonce-...') is required to enable inline execution.

CSP ì§€ì‹œìë¥¼ ìœ„ë°˜í–ˆê¸° ë•Œë¬¸ì— inline script ì‹¤í–‰ì„ ê±°ë¶€í•œë‹¤.
í˜„ì¬ CSP ì§€ì‹œìëŠ” 'nonce-1'ì´ë‹¤.
unsafe-inline í‚¤ì›Œë“œ,
hash : ('sha256-P9oV1Sc7O1Di7wEu1Q0fc9Jb2+DopNb6840c7E5XuNY=')
ë˜ëŠ” nonce ('nonce-...')ê°’ì´ ì¸ë¼ì¸ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì‹¤í–‰í•˜ê¸° ìœ„í•´ì„œ í•„ìš”í•˜ë‹¤.
```


ì—¬ê¸°ì—ì„œ ì´ ë¬¸ì œë¥¼ í’€ê¸° ìœ„í•´ì„œ ì‚¬ìš©í•  ë¶€ë¶„ì€ hash ë¶€ë¶„ì…ë‹ˆë‹¤. ì„œë²„ì—ì„œ ì‹¤í–‰ì„ í—ˆìš©í•  ìŠ¤í¬ë¦½íŠ¸ì˜ í•´ì‹œ ê°’ì„ ë¯¸ë¦¬ êµ¬í•´ë†“ê³ , í•´ë‹¹ í•´ì‹œ ê°’ê³¼ ë™ì¼í•œ ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰ ê°€ëŠ¥í•˜ë„ë¡ í•˜ëŠ” ê¸°ëŠ¥ì´ë©°, ì§€ê¸ˆ ë¬¸ì œì—ì„œ ì„œë²„ì˜ CSP ì§€ì‹œìë¥¼ ì„¤ì •í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ìœ„ì˜ ì˜¤ë¥˜ì—ì„œ ì¶œë ¥í•´ì¤€ í•´ì‹œ ê°’ì„ ë‹¤ìŒê³¼ ê°™ì´ ì„¤ì •í•´ ì¤€ë‹¤ë©´ ìœ„ì—ì„œ ì°¨ë‹¨ëœ ìŠ¤í¬ë¦½íŠ¸ í•˜ë‚˜ê°€ ì‹¤í–‰ ê°€ëŠ¥í•©ë‹ˆë‹¤

```
http://host1.dreamhack.games:16863/live?csp=script-src : 'sha256-P9oV1Sc7O1Di7wEu1Q0fc9Jb2+DopNb6840c7E5XuNY='
```


ìœ„ì—ì„œ ì„¤ì •í•œ CSPëŠ” **a** ìŠ¤í¬ë¦½íŠ¸ì˜ í•´ì‹œ ê°’ìœ¼ë¡œ, **a** ìŠ¤í¬ë¦½íŠ¸ë§Œ ì‹¤í–‰ì´ ê°€ëŠ¥í•œ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

![image](https://user-images.githubusercontent.com/33647663/159411410-43a52473-1475-4b3e-990e-9034b8fb93f4.png)

ì´ì œ ë¬¸ì œì—ì„œ ìš”êµ¬í•˜ëŠ” ì¡°ê±´ì¸ a,b ì˜ í•´ì‹œ ê°’ì€ ë„£ì§€ ì•Šê³ , c,d ìŠ¤í¬ë¦½íŠ¸ì˜ í•´ì‹œ ê°’ì„ ë„£ì–´ì„œ c,dë§Œ ì‹¤í–‰ê°€ëŠ¥í•˜ë„ë¡ í•´ì¤ë‹ˆë‹¤.

```php
// cì˜ í•´ì‹œ : 'sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8='
// dì˜ í•´ì‹œ : 'sha256-l1OSKODPRVBa1/91J7WfPisrJ6WCxCRnKFzXaOkpsY4='

script-src 'sha256-pasqAKBDmFT4eHoN2ndd6lN370kFiGUFyTiUHWhU7k8=' 'sha256-l1OSKODPRVBa1/91J7WfPisrJ6WCxCRnKFzXaOkpsY4='
```

ìœ„ì™€ ê°™ì´ csp ì§€ì‹œìë¥¼ ì„¤ì •í–ˆë”ë‹ˆ ì„±ê³µì ìœ¼ë¡œ c,dë§Œ ì‹¤í–‰ì´ ë˜ì—ˆìŠµë‹ˆë‹¤. 

![image](https://user-images.githubusercontent.com/33647663/159411671-2f8c8156-1897-43b4-b5e5-6ce4dca316ae.png)

ì´ì œ verify í˜ì´ì§€ì—ì„œ ë™ì¼í•˜ê²Œ cspë¥¼ ë„˜ê²¨ì£¼ë©´ ë¬¸ì œê°€ í’€ë¦½ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/33647663/159412743-1d8e4280-4edf-4744-97f1-1d3b22a0c116.png)