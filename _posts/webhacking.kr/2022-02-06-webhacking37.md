---
title: "[webhacking.kr] 37ë²ˆ ë¬¸ì œ í’€ì´[race condition]"
categories:
  - webhacking
tags:
  - webhacking.kr
  - wargame
  - python
toc: true
toc_sticky: true
toc_label: "37ë²ˆ ë¬¸ì œ í’€ì´"
toc_icon: "bookmark"
author_profile: true
header:
  teaser: /assets/images/webhacking.jpg
---

ğŸ’¡ Webhacking.kr challenge(old) 37ë²ˆ ë¬¸ì œì— ëŒ€í•œ í’€ì´ì…ë‹ˆë‹¤.
{: .notice--warning}

# ë¬¸ì œ
  ![image](https://user-images.githubusercontent.com/33647663/152673296-b58f30dd-510b-406a-994d-4d9370f2c5e6.png)

  ```php
<?php
  $db = dbconnect();
  $query = "select flag from challenge where idx=37";
  $flag = mysqli_fetch_array(mysqli_query($db,$query))['flag'];
  $time = time();

  $p = fopen("./tmp/tmp-{$time}","w");
  fwrite($p,"127.0.0.1");
  fclose($p);

  $file_nm = $_FILES['upfile']['name'];
  $file_nm = str_replace("<","",$file_nm);
  $file_nm = str_replace(">","",$file_nm);
  $file_nm = str_replace(".","",$file_nm);
  $file_nm = str_replace("/","",$file_nm);
  $file_nm = str_replace(" ","",$file_nm);

  if($file_nm){
    $p = fopen("./tmp/{$file_nm}","w");
    fwrite($p,$_SERVER['REMOTE_ADDR']);
    fclose($p);
  }

  echo "<pre>";
  $dirList = scandir("./tmp");
  for($i=0;$i<=count($dirList);$i++){
    echo "{$dirList[$i]}\n";
  }
  echo "</pre>";

  $host = file_get_contents("tmp/tmp-{$time}");

  $request = "GET /?{$flag} HTTP/1.0\r\n";
  $request .= "Host: {$host}\r\n";
  $request .= "\r\n";

  $socket = fsockopen($host,7777,$errstr,$errno,1);
  fputs($socket,$request);
  fclose($socket);

  if(count($dirList) > 20) system("rm -rf ./tmp/*");
?>
  ```

# ë¬¸ì œ í’€ì´
php ì½”ë“œê°€ ê¸¸ê¸° ë•Œë¬¸ì— í•µì‹¬ì ì¸ ë¶€ë¶„ë§Œ ìš”ì•½ì„ í•˜ë©´ ë‹¤ìŒ ë¶€ë¶„ë“¤ì…ë‹ˆë‹¤.

```php
#ë§¤ë²ˆ ìš”ì²­ì„ í• ë•Œë§ˆë‹¤ ì„œë²„ì—ì„œ tmp-$time í˜•ì‹ìœ¼ë¡œ íŒŒì¼ì„ ìƒì„±í•˜ê³ , íŒŒì¼ ì•ˆì— 127.0.0.1ì„ ì ëŠ”ë‹¤
$p = fopen("./tmp/tmp-{$time}","w");
  fwrite($p,"127.0.0.1");
  fclose($p);

#ì‚¬ìš©ìê°€ íŒŒì¼ì„ ì—…ë¡œë“œ í•˜ë©´ í•´ë‹¹ íŒŒì¼ ì•ˆì—ëŠ” ì‚¬ìš©ìì˜ ipë¥¼ ì ëŠ”ë‹¤.
$file_nm = $_FILES['upfile']['name'];
if($file_nm){
    $p = fopen("./tmp/{$file_nm}","w");
    fwrite($p,$_SERVER['REMOTE_ADDR']);
    fclose($p);
  }

#tmp-$time íŒŒì¼ì—ì„œ ipë¥¼ ì½ì–´ì™€ì„œ í•´ë‹¹ íŒŒì¼ì— ì“°ì—¬ì§„ ipë¡œ í”Œë˜ê·¸ ì •ë³´ê°€ í¬í•¨ëœ get ìš”ì²­ì„ í•œë‹¤.
$host = file_get_contents("tmp/tmp-{$time}");
$request = "GET /?{$flag} HTTP/1.0\r\n";
  $request .= "Host: {$host}\r\n";
  $request .= "\r\n";

  $socket = fsockopen($host,7777,$errstr,$errno,1);
  fputs($socket,$request);
```

ì´ë²ˆ ë¬¸ì œëŠ” race conditionì˜ ê°œë…ì„ ì´ìš©í•˜ëŠ” ë¬¸ì œë¡œ, ì„œë²„ê°€ ë¨¼ì € ìƒì„±í•œ tmp-{$time} íŒŒì¼ì„ ë®ì–´ì¨ì„œ 127.0.0.1ì´ ì•„ë‹Œ ë‚˜ì˜ ipë¡œ ìš”ì²­ì´ ì˜¤ë„ë¡ ë³€ê²½í•˜ëŠ” ê²ƒì…ë‹ˆë‹¤.



# ê²°ê³¼
ì´ë¥¼ íŒŒì´ì¬ ì½”ë“œë¡œ ì‘ì„±í•˜ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

<script src="https://gist.github.com/kangmyoungseok/4fc0e98f73bb5177ea5df2318dd8c436.js"></script>

ìœ„ì˜ ì½”ë“œë¥¼ ìš°ë¶„íˆ¬ í™˜ê²½ì—ì„œ ì‹¤í–‰í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ í”Œë˜ê·¸ë¥¼ íšë“ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

![image](https://user-images.githubusercontent.com/33647663/152673924-05a6deb3-773a-41b7-859e-07e7ef63bbab.png)